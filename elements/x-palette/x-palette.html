<link rel="import" href="../../components/core-icon/core-icon.html">
<link rel="import" href="../../components/core-item/core-item.html">
<link rel="import" href="../../components/core-menu/core-menu.html">
<link rel="import" href="../../components/core-menu/core-submenu.html">
<link rel="import" href="../../components/x-meta/x-meta.html">

<polymer-element name="x-palette" attributes="canvas drag">

  <template>

    <link rel="stylesheet" href="x-palette.css">

    <x-meta id="meta" categories="{{categories}}"></x-meta>

    <div id="list" on-trackstart="{{trackStart}}" on-track="{{track}}" on-trackend="{{trackEnd}}">

      <core-menu selectedClass="palette-selected">

        <template repeat="{{categories}}">

          <core-submenu class="group-item" label="{{name}}">

            <template repeat="{{list}}">
              <div class="simple-item" tag="{{id}}" loaded?="{{importsLoaded}}" ishidden?="{{isHidden}}">{{label}}</div>
            </template>

          </core-submenu>

        </template>

      </core-menu>

    </div>

  </template>

  <script>
    Polymer('x-palette', {

      categories: null,

      trackStart: function(event) {
        // our event
        event.stopPropagation();
        // drag source is a tag
        var tag = event.target.getAttribute('tag');
        if (tag) {
          // construct drag info
          this.drag = {
            tag: tag,
            origin: {left: event.pageX - 24, top: event.pageY - 24},
          };
          console.log('[%s]: trackStart', this.localName);
          // let whoever cares hook the process
          this.fire('palette-drag', this.drag);
        }
      },

      track: function(event) {
        event.stopPropagation();
        if (this.drag && this.drag.drag) {
          this.drag.drag(event);
        }
      },

      trackEnd: function(event) {
        // our event
        event.stopPropagation();
        // delegate dropping to the drag object
        if (this.drag) {
          var dropped = false;
          if (this.drag && this.drag.drop) {
            dropped = this.drag.drop(event)
          }
          if (!dropped) {
            this.drop(this.drag);
          }
          this.drag = null;
        }
      },

      drop: function(drag) {
        // dropping here sends the item to the bitbucket
        drag.element.parentNode.removeChild(drag.element);
      }

    });
  </script>

</polymer-element>
