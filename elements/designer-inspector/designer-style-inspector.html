<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../paper-menu/paper-menu.html">
<link rel="import" href="../../../paper-item/paper-item.html">
<link rel="import" href="../../src/commands/commands.html">
<link rel="import" href="../../src/dom-utils/dom-utils.html">
<link rel="import" href="../../src/rework-utils/rework-utils.html">
<link rel="import" href="designer-inspector-behavior.html">
<link rel="import" href="designer-style-rule-editor.html">

<!--
Displays the style rules that currently apply to `element`, and provides an
editing interface for them.
-->
<dom-module id="designer-style-inspector">

  <style>
    :host {
      @apply(--paper-font-body1);
      display: block;
      padding: 16px;
    }
    h2 {
      @apply(--designer-inspector-title);
    }
  </style>

  <template>
    <h2>Styles</h2>

    <paper-dropdown-menu
        label="Style"
        always-float-label>
      <paper-menu
          class="dropdown-content"
          selected="{{_currentSelector}}"
          attr-for-selected="value">
        <template is="dom-repeat" items="{{selectors}}">
          <paper-item value="{{item}}">{{item}}</paper-item>
        </template>
      </paper-menu>
    </paper-dropdown-menu>

    <designer-style-rule-editor rule="{{_currentRule}}">
    </designer-style-rule-editor>

  </template>

</dom-module>

<script>
define([
    'css',
    'polymer-designer/dom-utils',
    'polymer-designer/rework-utils',
    'polymer-designer/commands'],
    function(rework, domUtils, reworkUtils, commands) {
  'use strict';

  Polymer({

    is: 'designer-style-inspector',

    behaviors: [Polymer.DesignerInspectorBehavior],

    properties: {

      /**
       * Metadata published by the stage about the currently selected element.
       */
      selection: {
        type: Object,
        observer: '_selectionChanged',
      },

      /** The document where edits should be made */
      documentInfo: Object,

      _sheets: {
        type: Array,
        notify: true,
      },

      selectors: {
        type: Array,
        notify: true,
      },

      /**
       * Map of selector -> rule object
       */
      _rules: {
        type: Object,
      },

      _currentSelector: {
        type: String,
      },

      _currentRule: {
        type: Object,
        computed: '_computeCurrentRule(_currentSelector)',
      },

    },

    listeners: {
      'designer-element-style-changed': '_styleChanged',
    },

    _selectionChanged() {
      this._sheets = (this.selection &&
          this.selection.elementInfo &&
          this.selection.elementInfo.styles) || [];

      let selectors = [];
      this._rules = {};
      for (let sheet of this._sheets) {

        // find the source sheet
        let sourceStyle = domUtils.getNodeBySourceId(
            this.documentInfo.domDocument, sheet.ownerSourceId);
        // sheet._sourceStyleElement = sourceStyle;

        // parse the sheet
        let sheetSource = sourceStyle.textContent;
        let parsedSheet = rework.parse(sheetSource);

        // find the rule in the sheet
        for (let rule of sheet.rules) {
          let parsedRule =
              reworkUtils.getRule(parsedSheet, rule.selector, rule.index);

          parsedRule._sheetSource = sheetSource;
          parsedRule._parsedSheet = parsedSheet;
          parsedRule._sheet = sheet;

          selectors.push(rule.selector);
          this._rules[rule.selector] = parsedRule;
          rule._sheet = sheet;
        }
      }
      this.selectors = selectors;
      if (selectors.length > 0) {
        this._currentSelector = selectors[0];
      }
    },

    _computeCurrentRule(_currentSelector) {
      return this._rules[_currentSelector];
    },

    _styleChanged(event, info) {
      let rule = event.target.rule;
      let sheet = event.target.parentNode._sheet;
      this._updateSheet(info.rule._sheet, info.rule, info.property, info.value);
    },

    _updateSheet(sheet, rule, property, value) {
      let newSource =
          reworkUtils.replaceProperty(rule._sheetSource, rule, property, value);

      this.fire('designer-command',
          commands.setTextContent(rule._sheet.ownerSourceId, rule._sheetSource, newSource));
    },

  });

});
</script>
