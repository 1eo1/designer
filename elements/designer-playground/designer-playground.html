<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../core-ajax/core-request.html">
<link rel="import" href="../../../core-asset/core-asset.html">
<link rel="import" href="../../../core-toolbar/core-toolbar.html">
<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../src/commands/commands.html">
<link rel="import" href="../../src/parse5/parse5.html">
<link rel="import" href="../designer-breadcrumb/designer-breadcrumb.html">
<link rel="import" href="../designer-stage/designer-stage.html">
<link rel="import" href="../designer-inspector/designer-inspector.html">

<dom-module id="designer-playground">

  <style>
    :host {
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    #main {
      display: flex;
      flex-direction: row;
      flex: 1;
    }
    core-toolbar {
      background: #424242;
      color: white;
    }
    core-toolbar img.d-logo {
      width: 64px;
      height: 64px;
    }
    core-toolbar h2.d-logo {
      opacity: 0.87;
      font-weight: normal;
      display: inline;
    }
    #main > nav {
      background: #424242;
      color: white;
      flex: 0 0 240px;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }
    #main > nav > #files > a {
      display: block;
      color: currentColor;
      text-decoration: none;
      padding: 8px;
    }
    #main > nav > #files > a:hover {
      text-decoration: underline;
      cursor: pointer;
    }
    #main > nav > designer-inspector {
      flex: 1;
    }
    #main > #doc {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    #main > #doc > designer-stage {
      flex: 1;
    }
    #main > #doc > #html {
      flex: 0 0 400px;
      border: solid 1px #888;
      margin: 0;
      overflow: auto;
      background: #212121;
      color: white;
    }
  </style>

  <core-asset id="demo-doc-1" href="demo-doc-1.html"></core-asset>
  <core-asset id="demo-doc-2" href="demo-doc-2.html"></core-asset>
  <core-asset id="demo-doc-3" href="demo-doc-3.html"></core-asset>
  <core-asset id="demo-doc-4" href="demo-doc-4.html"></core-asset>
  <core-asset id="demo-doc-5" href="demo-doc-5.html"></core-asset>

  <template>
    <core-toolbar><img class="d-logo" src="PolymerLabs.png"> <h2 class="d-logo">Designer</h2></core-toolbar>
    <div id="main">
      <nav on-click="_navOnClick">
        <div id="files">
          <a data-demo="demo-doc-1">Demo 1</a>
          <a data-demo="demo-doc-2">inline</a>
          <a data-demo="demo-doc-3">inline-block</a>
          <a data-demo="demo-doc-4">block</a>
          <a data-demo="demo-doc-5">absolute</a>
        </div>
        <designer-inspector element-info="{{currentElementInfo}}"></designer-inspector>
        <div id="packages">
          <button on-click="_installPackageClick">Bower Install</button>
        </div>
      </nav>
      <div id="doc">
        <designer-breadcrumb node="{{currentNode}}"></designer-breadcrumb>
        <designer-stage id="stage" current-element-info="{{currentElementInfo}}"></designer-stage>
        <pre id="html"></pre>
      </div>
    <div>
  </template>

</dom-module>

<script>

  define(['DomCommandApplier', 'ParsedHtmlCommandApplier', 'Parse5', 'Path'],
      function(DomCommandApplier, ParsedHtmlCommandApplier, Parse5, pathLib) {
    'use strict';

    var parser = new Parse5.Parser(null, {locationInfo: true});
    var serializer = new Parse5.Serializer();

    Polymer({
      is: 'designer-playground',

      properties: {
        currentElementInfo: {
          type: Object,
          notify: true,
        },
        currentNode: {
          type: Object,
          notify: true,
          observer: 'currentNodeChanged',
        }
      },

      observers: {
        'currentElementInfo.path': 'pathChanged',
      },

      pathChanged() {
        if (this.currentElementInfo != null) {
          var path = this.currentElementInfo.path;
          var node = pathLib.getNodeFromPath(path, this.domDocument);
          this.currentNode = node;
        }
      },

      currentNodeChanged() {
        var path = pathLib.getNodePath(this.currentNode, this.domDocument);
        this.$.stage.selectNode(path);
      },

      configure() {
        return {
          currentElementInfo: null,
          currentNode: null,
          textDocument: null,
          domDocument: null,
          parsedDocument: null,
          domCommandApplier: null,
          parsedCommandApplier: null,
        };
      },

      ready() {
        this.$.stage.addEventListener('designer-command', (function(e) {
          var command = e.detail;

          this.domCommandApplier.apply(command);
          this.parsedCommandApplier.apply(command);

          if (this.parsedDocument != null) {
            this.$.html.textContent =
                serializer.serialize(this.parsedDocument);
          }
        }).bind(this));
      },

      _navOnClick(e) {
        if (e.target.tagName == 'A') {
          var module = document.createElement('dom-module');
          var demoName = e.target.dataset.demo;
          var demoAsset = module.import(this.is, '#' + demoName);

          demoAsset.load()
            .then(this.$.stage.setDocument.bind(this.$.stage))
            .then((function(result) {
              this.domDocument = result.document;
              this.parsedDocument = parser.parse(result.content);

              this.domCommandApplier = new DomCommandApplier(this.domDocument);
              this.parsedCommandApplier = new ParsedHtmlCommandApplier(this.parsedDocument);
              this.$.html.textContent = serializer.serialize(this.parsedDocument);

            }).bind(this));
        }
      },

      _installPackageClick(e) {
        var request = document.createElement('core-request');
        request.send({
          url: '/api/bowerInstall',
          method: "POST",
          headers: {},
          async: true,
        });
      },
    });
  });

</script>
